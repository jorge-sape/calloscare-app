// CallosCare App v4.7 - Ecr√£ de Resultados Completo
const CallosCareApp = {
    // ... (mantenha todo o c√≥digo anterior igual at√© a fun√ß√£o generateTreatmentHtml)

    generateTreatmentHtml(d) {
        let fullHtml = '';
        let suggestedProducts = new Set();
        const findContent = (key) => this.state.appConfig.app_content.find(c => c.content_key === key);
        const findProduct = (name) => this.state.appConfig.products.find(p => p.name === name);

        // 1. RESUMO DA AVALIA√á√ÉO
        fullHtml += `
            <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6 shadow-sm">
                <h3 class="text-xl font-bold text-center mb-4 text-blue-800">üìã Resumo da Sua Avalia√ß√£o</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div class="space-y-2">
                        <p><strong>Tipo de Les√£o:</strong> ${d.callusType || 'N√£o especificado'}</p>
                        <p><strong>Localiza√ß√£o:</strong> ${(d.locations || []).map(loc => {
                            const locNames = {
                                'dedo_grande': 'Dedo Grande', 'dedo_pequeno': 'Dedo Pequeno', 
                                'entre_dedos': 'Entre os Dedos', 'em_cima_dedos': 'Em Cima dos Dedos',
                                'bola_pe': 'Bola do P√©', 'calcanhar': 'Calcanhar', 'lateral': 'Lateral do P√©'
                            };
                            return locNames[loc] || loc;
                        }).join(', ') || 'N√£o especificada'}</p>
                        <p><strong>N√≠vel de Dor:</strong> ${d.painLevel || 0}/10</p>
                    </div>
                    <div class="space-y-2">
                        <p><strong>Inflama√ß√£o:</strong> ${d.inflammation ? 'Sim' : 'N√£o'}</p>
                        <p><strong>Tipo de P√©:</strong> ${d.footType === 'seco' ? 'P√©s Secos' : d.footType === 'humido' ? 'P√©s H√∫midos' : d.footType === 'normal' ? 'P√©s Normais' : 'N√£o especificado'}</p>
                        <p><strong>Deformidade:</strong> ${d.hasDeformity ? 'Sim' : 'N√£o'}</p>
                    </div>
                </div>
            </div>
        `;

        // 2. PROTOCOLO DE EMERG√äNCIA (se aplic√°vel)
        if (d.painLevel >= 7 || d.inflammation) {
            const kit = findContent('emergency_kit_protocol');
            if(kit) {
                fullHtml += `
                    <div class="p-4 border-l-4 border-red-500 bg-red-50 rounded-lg mb-4 prose max-w-none">
                        <h3 class="text-red-700 font-bold text-center text-lg mb-3">
                            <i class="fas fa-exclamation-triangle mr-2"></i>${kit.title}
                        </h3>
                        <div class="text-left">${this.makeProductsInteractive(kit.content_html)}</div>
                    </div>
                `;
                // Adicionar produtos de emerg√™ncia
                this.state.appConfig.products.forEach(p => {
                    if(p.category === 'inflamacao_dor') suggestedProducts.add(p.name);
                });
            }
        }
        
        // 3. PROTOCOLO PRINCIPAL PARA O TIPO DE CALO
        let callusKey = (d.callusType || '').toLowerCase()
            .replace(/ \/ /g, '_')
            .replace(/ /g, '_')
            .replace(/[()]/g, '') + '_protocol';
        
        // Handle specific case for verruga
        if (d.callusType === "Olho-de-peixe") {
            callusKey = 'verruga_protocol';
        }

        const mainProtocol = findContent(callusKey);
        if(mainProtocol) {
            fullHtml += `
                <div class="p-4 border-l-4 border-blue-500 bg-blue-50 rounded-lg mb-4 prose max-w-none">
                    <h3 class="font-bold text-center text-lg mb-3">Protocolo para ${d.callusType}</h3>
                    <div class="text-left">${this.makeProductsInteractive(mainProtocol.content_html)}</div>
                </div>
            `;
        }

        // 4. RECOMENDA√á√ïES ADICIONAIS BASEADAS NAS RESPOSTAS
        if (d.hasDeformity) {
            const deformityInfo = findContent('deformity_info');
            if(deformityInfo) {
                fullHtml += `
                    <div class="p-4 border-l-4 border-yellow-500 bg-yellow-50 rounded-lg mb-4 prose max-w-none">
                        <h3 class="font-bold text-center text-lg mb-3">Nota sobre Deformidades</h3>
                        <div class="text-left">${this.makeProductsInteractive(deformityInfo.content_html)}</div>
                    </div>
                `;
            }
        }

        // 5. PRODUTOS SUGERIDOS BASEADOS NO TIPO DE P√â E SINTOMAS
        this.state.appConfig.products.forEach(p => {
            if(d.footType === 'seco' && p.category === 'hidratacao') suggestedProducts.add(p.name);
            if(d.footType === 'humido' && p.category === 'controlo_humidade') suggestedProducts.add(p.name);
            if(d.inflammation && p.category === 'inflamacao_dor') suggestedProducts.add(p.name);
            // Produtos espec√≠ficos para o tipo de calo
            if(d.callusType && p.indications && p.indications.includes(d.callusType.toLowerCase())) {
                suggestedProducts.add(p.name);
            }
        });

        d.suggestedProducts = Array.from(suggestedProducts);
        d.interactiveSelections = d.interactiveSelections || {};
        
        return { fullHtml, suggestedProducts: d.suggestedProducts };
    },

    makeProductsInteractive(html) {
        // Esta fun√ß√£o transforma men√ß√µes a produtos em elementos clic√°veis
        // Para v4.7, vamos implementar uma vers√£o b√°sica
        const productNames = this.state.appConfig.products.map(p => p.name);
        
        let interactiveHtml = html;
        productNames.forEach(productName => {
            const regex = new RegExp(`\\b${productName}\\b`, 'gi');
            interactiveHtml = interactiveHtml.replace(regex, 
                `<span class="text-blue-600 underline cursor-pointer font-medium" 
                      onclick="CallosCareApp.showProductSelection('${productName}')">${productName}</span>`
            );
        });
        
        return interactiveHtml;
    },

    showProductSelection(productName) {
        const product = this.state.appConfig.products.find(p => p.name === productName);
        if (!product) return;

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <span onclick="this.parentElement.parentElement.remove()" class="float-right text-2xl font-bold cursor-pointer">&times;</span>
                <h3 class="text-xl font-bold mb-4">${product.name}</h3>
                <div class="prose max-w-none mb-4">
                    <p><strong>Categoria:</strong> ${product.category}</p>
                    <p><strong>Descri√ß√£o:</strong> ${product.description || 'Sem descri√ß√£o dispon√≠vel'}</p>
                    ${product.benefits ? `<p><strong>Benef√≠cios:</strong> ${product.benefits}</p>` : ''}
                </div>
                <div class="flex justify-between items-center">
                    <label class="flex items-center">
                        <input type="checkbox" id="product-select-${product.id}" 
                               ${this.state.diagnosis.interactiveSelections?.[product.name] ? 'checked' : ''}
                               onchange="CallosCareApp.toggleProductSelection('${product.name}', this.checked)"
                               class="mr-2 h-5 w-5 text-blue-600">
                        <span>Adicionar √† minha lista</span>
                    </label>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg">
                        Fechar
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        modal.style.display = 'block';
    },

    toggleProductSelection(productName, isSelected) {
        if (!this.state.diagnosis.interactiveSelections) {
            this.state.diagnosis.interactiveSelections = {};
        }
        
        if (isSelected) {
            this.state.diagnosis.interactiveSelections[productName] = true;
            // Adicionar √† lista de produtos sugeridos se n√£o estiver j√°
            if (!this.state.diagnosis.suggestedProducts.includes(productName)) {
                this.state.diagnosis.suggestedProducts.push(productName);
            }
        } else {
            delete this.state.diagnosis.interactiveSelections[productName];
            // Remover da lista de produtos sugeridos
            const index = this.state.diagnosis.suggestedProducts.indexOf(productName);
            if (index > -1) {
                this.state.diagnosis.suggestedProducts.splice(index, 1);
            }
        }
        
        // Atualizar a renderiza√ß√£o para refletir as mudan√ßas
        this.render();
    },

    showFullProductCatalog() {
        const products = this.state.appConfig.products;
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <span onclick="this.parentElement.parentElement.remove()" class="float-right text-2xl font-bold cursor-pointer">&times;</span>
                <h3 class="text-2xl font-bold mb-6 text-center">Cat√°logo Completo de Produtos</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
                    ${products.map(product => `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-bold text-lg mb-2">${product.name}</h4>
                            <p class="text-sm text-gray-600 mb-2"><strong>Categoria:</strong> ${product.category}</p>
                            <p class="text-sm mb-3">${product.description || 'Sem descri√ß√£o dispon√≠vel'}</p>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" 
                                       ${this.state.diagnosis.interactiveSelections?.[product.name] ? 'checked' : ''}
                                       onchange="CallosCareApp.toggleProductSelection('${product.name}', this.checked)"
                                       class="mr-2 h-4 w-4 text-blue-600">
                                Selecionar
                            </label>
                        </div>
                    `).join('')}
                </div>
                <div class="text-center mt-6">
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg">
                        Fechar Cat√°logo
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        modal.style.display = 'block';
    },

    // ATUALIZA√á√ÉO DO RENDER() PARA STEP5_RESULTS
    render() {
        this.updateProgressBar();
        const container = document.getElementById('calloscare-main-content');
        let content = '';
        const d = this.state.diagnosis;
        document.getElementById('app-title').innerHTML = `CallosCare <span class="text-sm font-light opacity-75">${this.VERSION}</span>`;
        
        const warningBanner = document.getElementById('diabetic-warning-banner');
        if (d && d.is_diabetic && this.state.currentStep.startsWith('step')) { 
            if(warningBanner) warningBanner.classList.remove('hidden'); 
        } else { 
            if(warningBanner) warningBanner.classList.add('hidden'); 
        }

        switch (this.state.currentStep) {
            // ... (mantenha todos os cases anteriores iguais)
            
            case 'step5_results':
                const results = this.generateTreatmentHtml(d);
                const selectedProducts = d.interactiveSelections ? Object.keys(d.interactiveSelections) : [];
                
                content = `
                    <h2 class="text-2xl font-semibold text-center mb-6">Plano de Tratamento Individualizado</h2>
                    
                    <div id="treatment-results-content" class="space-y-6">
                        ${results.fullHtml}
                    </div>
                    
                    <!-- LISTA DE PRODUTOS SUGERIDOS -->
                    <div class="mt-8 p-6 bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-bold text-lg text-gray-800">üõçÔ∏è Lista de Produtos Sugeridos</h4>
                            <button onclick="CallosCareApp.showFullProductCatalog()" 
                                    class="text-blue-600 text-sm underline hover:text-blue-800">
                                (veja toda a lista de produtos)
                            </button>
                        </div>
                        
                        <!-- Produtos Selecionados pelo Utilizador -->
                        ${selectedProducts.length > 0 ? `
                            <div class="mb-4">
                                <p class="text-sm text-gray-600 mb-2">‚úÖ <strong>Os seus produtos selecionados:</strong></p>
                                <ul class="list-disc pl-5 space-y-1">
                                    ${selectedProducts.map(p => `<li class="text-green-600 font-medium">${p}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        <!-- Produtos Sugeridos pelo Sistema -->
                        <div>
                            <p class="text-sm text-gray-600 mb-2"><strong>Sugest√µes baseadas na sua avalia√ß√£o:</strong></p>
                            <ul class="list-disc pl-5 space-y-1 text-left">
                                ${(d.suggestedProducts && d.suggestedProducts.length > 0) ? 
                                    d.suggestedProducts.map(p => `
                                        <li class="${selectedProducts.includes(p) ? 'text-green-600 font-medium' : ''}">
                                            ${p}
                                            ${!selectedProducts.includes(p) ? `
                                                <button onclick="CallosCareApp.toggleProductSelection('${p}', true)" 
                                                        class="ml-2 text-blue-600 text-xs underline">
                                                    adicionar
                                                </button>
                                            ` : `
                                                <button onclick="CallosCareApp.toggleProductSelection('${p}', false)" 
                                                        class="ml-2 text-red-600 text-xs underline">
                                                    remover
                                                </button>
                                            `}
                                        </li>
                                    `).join('') : 
                                    '<li class="text-gray-500">Nenhum produto espec√≠fico sugerido.</li>'
                                }
                            </ul>
                        </div>
                    </div>
                    
                    <!-- BOT√ïES DE A√á√ÉO -->
                    <div class="flex justify-between items-center mt-8">
                        ${d.isSaved ? `
                            <span class="text-green-600 font-bold flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>Diagn√≥stico Guardado ‚úì
                            </span>
                            <button onclick="CallosCareApp.goToStep('home')" 
                                    class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">
                                Voltar ao Menu Principal
                            </button>
                        ` : `
                            <button onclick="CallosCareApp.goToStep('step4_footType')" 
                                    class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                                ‚Üê Voltar e Editar
                            </button>
                            <button onclick="CallosCareApp.saveDiagnosis()" 
                                    class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors flex items-center">
                                Guardar Diagn√≥stico 
                                <i id="save-diag-spinner" class="fas fa-spinner fa-spin hidden ml-2"></i>
                            </button>
                        `}
                    </div>
                `;
                break;
                
            default:
                content = `<p class="text-center">Ocorreu um erro de navega√ß√£o. <a href="#" onclick="CallosCareApp.goToStep('home')" class="text-blue-600">Voltar ao in√≠cio.</a></p>`;
                break;
        }
        container.innerHTML = `<div class="calloscare-step active">${content}</div>`;
    }
};

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', () => CallosCareApp.init());
