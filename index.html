<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CallosCare V5.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        #calloscare-app-container { font-family: 'Inter', sans-serif; }
        .calloscare-step { display: none; }
        .calloscare-step.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
        .calloscare-option-card { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .calloscare-option-card:hover { transform: translateY(-5px); }
        .calloscare-option-card.selected { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); }
        .calloscare-btn.selected { background-color: #2563eb !important; color: white !important; }
        .calloscare-btn.selected span { color: white !important; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; } .prose li { margin-top: 0.5rem; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; }
        .zoom-modal .modal-content { background: transparent; border: none; padding: 0; max-width: 90vw; max-height: 90vh; }
        .zoom-modal img { width: 100%; height: 100%; object-fit: contain; }
        .product-selected { color: #059669 !important; font-weight: 600 !important; }
        .investigation-option { transition: all 0.3s ease; }
        .investigation-option:hover { transform: scale(1.02); }
        
        /* NOVOS ESTILOS V5.0 */
        .inline-product { color: #2563eb; text-decoration: underline; cursor: pointer; }
        .inline-product-selected { color: #059669; font-weight: 600; cursor: pointer; }
        .product-marker .btn-edit-products { margin-left: 8px; background: none; border: none; color: #6b7280; cursor: pointer; font-size: 12px; }
        .temp-modal { /* modal base class */ }
        .text-muted { color: #6b7280; font-size: 13px; }
        .sep { margin: 0 6px; color: #9ca3af; }
        .emergency-section { border-left: 4px solid #ef4444 !important; background-color: #fef2f2 !important; }
    </style>
</head>
<body>

<div id="calloscare-app-container" class="max-w-4xl mx-auto bg-gray-50 p-4 sm:p-6 rounded-lg shadow-lg">
    <header class="text-center mb-6 bg-blue-600 p-4 rounded-lg shadow-md">
        <h1 id="app-title" class="text-3xl font-bold text-white">CallosCare <span class="text-sm font-light opacity-75">v5.0</span></h1>
        <p class="text-md text-blue-100">Assistente de Diagn√≥stico e Tratamento da DOR e dos seus Calos</p>
    </header>
    <div id="diabetic-warning-banner" class="hidden p-3 mb-4 bg-red-100 border-l-4 border-red-500 text-red-700">
        <p><i class="fas fa-exclamation-triangle mr-2"></i><strong>Aviso:</strong> Como diab√©tico/com m√° circula√ß√£o, o auto-tratamento apresenta riscos. Use esta ferramenta como guia educativo e consulte sempre um profissional.</p>
    </div>
    <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5 mb-8 hidden">
        <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full progress-bar-fill" style="width: 0%"></div>
    </div>
    <main id="calloscare-main-content"></main>
</div>

<div id="image-zoom-modal" class="modal zoom-modal" onclick="CallosCareApp.closeModal()">
    <div class="modal-content"><img id="zoomed-image" src="" alt="Imagem Ampliada"></div>
</div>
<div id="definition-modal" class="modal">
    <div class="modal-content">
        <span onclick="CallosCareApp.closeModal()" class="float-right text-2xl font-bold cursor-pointer">&times;</span>
        <h2 id="definition-title" class="text-2xl font-bold mb-4"></h2>
        <div id="definition-text" class="text-gray-700 prose"></div>
    </div>
</div>

<script>
// CallosCare App v5.0 - SISTEMA INTELIGENTE COMPLETO COM MELHORIAS V5.0
const CallosCareApp = {
    API_BASE_URL: '/api',
    VERSION: 'v5.0',
    state: { 
        user: null, 
        appConfig: null, 
        currentStep: 'loading', 
        diagnosis: {
            locations: [],
            physicalChanges: [],
            selectedProducts: {},
            isSaved: false
        },
        investigation: { currentQuestion: 0, answers: {}, recommendations: [] }
    },

    async init() {
        this.render(); 
        this.loadUserFromLocalStorage();
        try { 
            this.state.appConfig = await this.api.getAppConfig(); 
            this.ensureDisinfectionProducts(); 
            this.state.currentStep = this.state.user ? 'home' : 'identification';
        } catch (error) { 
            console.error("Initialization Error:", error); 
            this.state.currentStep = 'error'; 
        }
        this.render();
    },

    // =============================================
    // MELHORIAS V5.0 - SISTEMA DE PRODUTOS DIN√ÇMICO
    // =============================================

    // Processar marcadores de produtos no texto
    processProductMarkers(html) {
        if (!html) return html;
        
        const productMarkerRegex = /\{products:([^}]+)\}/g;
        let processedHtml = html;
        let match;

        while ((match = productMarkerRegex.exec(html)) !== null) {
            const fullMatch = match[0];
            const category = match[1];
            
            const categoryProducts = this.state.appConfig.interactive_products?.filter(p => 
                p.category === category
            ) || [];
            
            if (categoryProducts.length > 0) {
                // Obter produtos selecionados e sugeridos
                const selectedProducts = this.state.diagnosis.selectedProducts?.[category] || [];
                const suggestedProducts = categoryProducts.slice(0, 3).map(p => p.product_name); // Top 3 por prioridade
                
                const allProducts = Array.from(new Set([...suggestedProducts, ...selectedProducts]));
                
                const interactiveElement = `
                    <span class="product-marker" data-category="${category}">
                        ${allProducts.map(product => {
                            const isSelected = selectedProducts.includes(product);
                            const className = isSelected ? 'inline-product-selected' : 'inline-product';
                            return `<span class="${className}" 
                                      onclick="CallosCareApp.toggleInlineProductSelection('${product.replace(/'/g, "\\'")}', '${category.replace(/'/g, "\\'")}')">
                                    ${product}
                                  </span>`;
                        }).join('<span class="sep">, </span>')}
                        <button class="btn-edit-products" onclick="CallosCareApp.showProductSelection('${category.replace(/'/g, "\\'")}')">
                            Editar
                        </button>
                    </span>
                `;
                
                processedHtml = processedHtml.replace(fullMatch, interactiveElement);
            }
        }
        
        return processedHtml;
    },

    // Alternar sele√ß√£o de produto inline
    toggleInlineProductSelection(productName, categorySlug) {
        if (!this.state.diagnosis.selectedProducts) {
            this.state.diagnosis.selectedProducts = {};
        }
        
        const arr = this.state.diagnosis.selectedProducts[categorySlug] || [];
        const index = arr.indexOf(productName);
        
        if (index > -1) {
            arr.splice(index, 1);
        } else {
            arr.push(productName);
        }
        
        if (arr.length > 0) {
            this.state.diagnosis.selectedProducts[categorySlug] = arr;
        } else {
            delete this.state.diagnosis.selectedProducts[categorySlug];
        }
        
        this.render();
    },

    // =============================================
    // MELHORIAS V5.0 - REGRA DE OURO ATUALIZADA
    // =============================================

    renderHygieneRule() {
        return `
            <div class="p-4 border-l-4 border-green-500 bg-green-50 rounded-lg mb-4">
                <h3 class="font-bold text-center text-lg mb-3">
                    <i class="fas fa-hand-sparkles mr-2"></i>Regra de Ouro de Higiene
                </h3>
                <ol class="list-decimal pl-5 space-y-2">
                    <li><strong>Lave e seque os p√©s:</strong> √°gua morna e sab√£o neutro, seque muito bem.</li>
                    <li><strong>Desinfete a √°rea (opcional, mas recomendado):</strong> produtos como 
                        <span class="inline-product-selected" onclick="CallosCareApp.toggleInlineProductSelection('Povidona-iodada', 'Desinfec√ß√£o')">Povidona-iodada</span>.
                    </li>
                    <li><strong>Desinfete os utens√≠lios:</strong> √°gua e sab√£o, depois √°lcool 70¬∫.</li>
                    <li><strong>Lave as suas m√£os:</strong> antes e depois de tratar os p√©s.</li>
                </ol>
            </div>
        `;
    },

    // =============================================
    // MELHORIAS V5.0 - KIT DE EMERG√äNCIA EM VERMELHO
    // =============================================

    renderEmergencyKit() {
        return `
            <div class="p-4 border-l-4 border-red-500 bg-red-50 rounded-lg mb-4 emergency-section">
                <h3 class="font-bold text-center text-lg mb-3 text-red-800">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Kit de Emerg√™ncia para Aliviar a Dor e a Inflama√ß√£o
                </h3>
                <p class="mb-3"><strong>Para acalmar a dor de um calo muito doloroso:</strong></p>
                <ul class="list-disc pl-5 space-y-1">
                    <li><strong>Higiene:</strong> lavar a √°rea com √°gua morna e sab√£o neutro.</li>
                    <li><strong>Gelo:</strong> 10-15 minutos, 3x ao dia.</li>
                    <li><strong>Anti-inflamat√≥rios e Analg√©sicos:</strong> 
                        ${this.processProductMarkers('{products:inflamacao_dor}')} ou 
                        ${this.processProductMarkers('{products:medicacao}')}.
                    </li>
                    <li><strong>Repouso</strong> com eleva√ß√£o do p√©.</li>
                </ul>
                
                <details class="mt-4 bg-white p-3 rounded-lg border border-red-200">
                    <summary class="cursor-pointer font-bold text-red-700">NOTA DE SEGURAN√áA (CLIQUE PARA LER)</summary>
                    <div class="mt-2 text-sm text-red-600">
                        <ul class="list-disc pl-5 space-y-1">
                            <li>Consulte SEMPRE a bula do medicamento antes de o tomar.</li>
                            <li>As informa√ß√µes acima s√£o gen√©ricas e a posologia pode variar consoante o produto.</li>
                            <li>N√ÉO exceda a dose di√°ria m√°xima recomendada na embalagem.</li>
                            <li>Estes medicamentos t√™m contraindica√ß√µes. N√ÉO os tome se for al√©rgico a algum componente, 
                                tiver √∫lceras g√°stricas, problemas graves de rins, f√≠gado ou cora√ß√£o, ou se estiver gr√°vida 
                                (especialmente no √∫ltimo trimestre).</li>
                            <li>Aconselhe-se sempre com um farmac√™utico ou m√©dico.</li>
                            <li>Interrompa o uso e consulte um m√©dico imediatamente se experienciar qualquer efeito secund√°rio.</li>
                        </ul>
                    </div>
                </details>
            </div>
        `;
    },

    // =============================================
    // MELHORIAS V5.0 - BOT√ÉO VER TRATAMENTO COMPLETO
    // =============================================

    showFullProtocol(contentKey) {
        const fullProtocols = this.state.appConfig.full_protocols || {};
        const protocol = fullProtocols[contentKey];
        
        if (!protocol) {
            alert('Protocolo completo n√£o dispon√≠vel no momento.');
            return;
        }

        const modal = document.createElement('div');
        modal.className = 'modal temp-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <span onclick="this.parentElement.parentElement.remove()" class="float-right text-2xl font-bold cursor-pointer">&times;</span>
                <h3 class="text-2xl font-bold mb-4">${protocol.title || 'Tratamento Completo'}</h3>
                <div class="prose max-w-none max-h-96 overflow-y-auto">
                    ${protocol.content_html || 'Conte√∫do n√£o dispon√≠vel.'}
                </div>
                <div class="text-center mt-6">
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg">
                        Fechar
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        modal.style.display = 'block';
    },

    // =============================================
    // FUN√á√ïES EXISTENTES (ATUALIZADAS)
    // =============================================

    loadUserFromLocalStorage() { 
        try { 
            const u = localStorage.getItem('calloscareUser'); 
            if(u) this.state.user = JSON.parse(u); 
        } catch(e){} 
    },
    
    saveUserToLocalStorage() { 
        localStorage.setItem('calloscareUser', JSON.stringify(this.state.user)); 
    },

    api: {
        async getAppConfig() { 
            const r = await fetch(`${CallosCareApp.API_BASE_URL}/getAppConfig`); 
            if (!r.ok) throw new Error('Network response was not ok'); 
            return r.json(); 
        },
        async saveClientData(d) { 
            const r = await fetch(`${CallosCareApp.API_BASE_URL}/saveClient`,{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify(d)
            }); 
            if (!r.ok) throw new Error('Failed to save client data'); 
            return r.json(); 
        },
        async saveDiagnosticData(d) { 
            const r = await fetch(`${CallosCareApp.API_BASE_URL}/saveDiagnostic`,{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify(d)
            }); 
            if (!r.ok) throw new Error('Failed to save diagnostic data'); 
            return r.json(); 
        },
    },

    async saveUser() {
        const fn = document.getElementById('user-first-name').value.trim(),
              ln = document.getElementById('user-last-name').value.trim(),
              e = document.getElementById('user-email')?.value.trim();
              
        if(!fn || !ln || !e || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)){ 
            alert('Por favor, preencha todos os campos com um email v√°lido.'); 
            return; 
        }
        
        const ud = {firstName: fn, lastName: ln, email: e};
        this.showSpinner('save-client-spinner');
        
        try { 
            const res = await this.api.saveClientData(ud); 
            this.state.user = { ...res.data[0] }; 
            this.saveUserToLocalStorage(); 
            this.goToStep('home');
        } catch (err) { 
            alert(`Erro: ${err.message}`); 
        } finally { 
            this.hideSpinner('save-client-spinner'); 
        }
    },
    
    startDiagnosis() { 
        this.state.diagnosis = {
            locations: [],
            physicalChanges: [],
            selectedProducts: {},
            isSaved: false
        }; 
        this.goToStep('step0_triage'); 
    },
    
    goToStep(step) { 
        this.state.currentStep = step; 
        window.scrollTo(0,0); 
        this.render(); 
    },
    
    selectCallusType(contentKey) {
        const type = this.state.appConfig.app_content.find(c => c.content_key === contentKey);
        if (type) {
            this.state.diagnosis.callusType = type.title.replace('O que √© um ','').replace('?','');
            this.render();
            const nextButton = document.querySelector('.step-next-btn');
            if(nextButton) nextButton.disabled = false;
            setTimeout(() => nextButton?.focus(), 100);
        }
    },
    
    selectOption(key, value, nextFocusId = null) {
        this.state.diagnosis[key] = value;
        this.render();
        if (nextFocusId) { 
            setTimeout(() => { 
                const el = document.getElementById(nextFocusId); 
                if(el) el.focus({ preventScroll: true }); 
            }, 100); 
        } else { 
            setTimeout(() => document.querySelector('.step-next-btn')?.focus(), 100); 
        }
    },

    toggleMultiOption(key, value){
        let a = this.state.diagnosis[key] || [];
        const i = a.indexOf(value);
        if(i > -1){
            a.splice(i,1);
        } else {
            a.push(value);
        }
        this.state.diagnosis[key] = a;
        this.render();
    },
    
    generateAndGoToResults() {
        const d = this.state.diagnosis;
        const results = this.generateTreatmentHtml(d);
        d.treatment_html = results.fullHtml;
        d.suggestedProducts = results.suggestedProducts;
        this.goToStep('step5_results');
    },

    async saveDiagnosis() {
        this.showSpinner('save-diag-spinner');
        const d = this.state.diagnosis;
        const payload = { 
            client_id: this.state.user.id, 
            callus_type_name: d.callusType, 
            pain_level: d.painLevel, 
            inflammation: d.inflammation, 
            locations: d.locations, 
            foot_type: d.footType, 
            has_deformity: d.hasDeformity, 
            is_diabetic: d.is_diabetic, 
            treatment_protocol_html: d.treatment_html, 
            suggested_products_snapshot: JSON.stringify(d.suggestedProducts),
            selected_products: JSON.stringify(d.selectedProducts || {})
        };
        
        try {
            await this.api.saveDiagnosticData(payload);
            d.isSaved = true;
            this.render();
        } catch (error) { 
            alert(`Erro ao guardar: ${error.message}`);
        } finally { 
            this.hideSpinner('save-diag-spinner'); 
        }
    },

    // =============================================
    // INVESTIGA√á√ÉO (MANTIDO DA V4.9)
    // =============================================

    getInvestigationQuestions() {
        if (this.state.appConfig.cause_investigation_questions) {
            return this.state.appConfig.cause_investigation_questions;
        }
        return [
            {
                category: "üìÅ CAL√áADO",
                questions: [
                    {
                        question_key: "shoe_too_short",
                        question_text: "√â demasiado pequeno (curto)?",
                        investigation_advice: "Se o sapato √© curto, os dedos ficam encavalitados. Solu√ß√£o: compre um n√∫mero maior.",
                        related_products: ["cal√ßado_maior"],
                        color: "red"
                    }
                ]
            }
        ];
    },

    getCurrentInvestigationQuestion() {
        const allQuestions = this.getAllInvestigationQuestionsFlat();
        return allQuestions[this.state.investigation.currentQuestion];
    },

    getCurrentInvestigationGroup() {
        const questions = this.getInvestigationQuestions();
        let questionIndex = 0;
        for (const group of questions) {
            for (const question of group.questions) {
                if (questionIndex === this.state.investigation.currentQuestion) {
                    return group;
                }
                questionIndex++;
            }
        }
        return null;
    },

    getAllInvestigationQuestionsFlat() {
        const groups = this.getInvestigationQuestions();
        return groups.flatMap(group => group.questions);
    },

    getTotalInvestigationQuestions() {
        return this.getAllInvestigationQuestionsFlat().length;
    },

    goToNextInvestigationQuestion() {
        this.state.investigation.currentQuestion++;
        if (this.state.investigation.currentQuestion >= this.getTotalInvestigationQuestions()) {
            this.goToStep('step7_investigation_results');
        } else {
            this.render();
        }
    },

    answerInvestigationQuestion(answer) {
        const currentGroup = this.getCurrentInvestigationGroup();
        const currentQuestion = this.getCurrentInvestigationQuestion();
        if (!currentQuestion) return;
        this.state.investigation.answers[currentQuestion.question_key] = answer;
        if (answer === true && currentQuestion.investigation_advice) {
            this.state.investigation.recommendations.push({
                category: currentGroup.category,
                question: currentQuestion.question_text,
                advice: currentQuestion.investigation_advice,
                products: currentQuestion.related_products || [],
                color: currentQuestion.color || 'blue'
            });
        }
        this.goToNextInvestigationQuestion();
    },

    startCauseInvestigation() {
        this.state.investigation = { currentQuestion: 0, answers: {}, recommendations: [] };
        this.goToStep('step6_investigation');
    },

    // =============================================
    // GERA√á√ÉO DE TRATAMENTO (ATUALIZADA V5.0)
    // =============================================

    generateTreatmentHtml(d) {
        let fullHtml = '';
        let suggestedProducts = new Set();
        const findContent = (key) => this.state.appConfig.app_content.find(c => c.content_key === key);

        // 1. REGRA DE HIGIENE ATUALIZADA (V5.0)
        fullHtml += this.renderHygieneRule();

        // 2. KIT DE EMERG√äNCIA EM VERMELHO (V5.0)
        if (d.painLevel >= 7 || d.inflammation) {
            fullHtml += this.renderEmergencyKit();
        }
        
        // 3. TRATAMENTO PRINCIPAL
        if (d.callusType) {
            const callusKey = this.getCallusProtocolKey(d.callusType);
            const mainProtocol = findContent(callusKey);
            
            if(mainProtocol) {
                fullHtml += this.renderContentSection(mainProtocol, 'blue', `Protocolo para ${d.callusType}`, null, callusKey);
            }
        }

        // 4. NOTA SOBRE DEFORMIDADES
        if (d.hasDeformity) {
            const deformityContent = findContent('deformity_info');
            if(deformityContent) {
                fullHtml += this.renderContentSection(deformityContent, 'yellow', 'Nota sobre Deformidades', null, 'deformity_info');
            }
        }

        // 5. GERAR LISTA FINAL DE PRODUTOS
        this.generateSmartSuggestedProducts(d, suggestedProducts);
        d.suggestedProducts = Array.from(suggestedProducts);
        
        return { fullHtml, suggestedProducts: d.suggestedProducts };
    },

    renderContentSection(content, color, defaultTitle = null, icon = null, contentKey = null) {
        const colorClasses = {
            'green': 'border-green-500 bg-green-50',
            'red': 'border-red-500 bg-red-50',
            'blue': 'border-blue-500 bg-blue-50', 
            'yellow': 'border-yellow-500 bg-yellow-50'
        };
        const iconHtml = icon ? `<i class="fas fa-${icon} mr-2"></i>` : '';
        
        // BOT√ÉO VER TRATAMENTO COMPLETO (V5.0)
        const seeMoreBtn = contentKey ? `
            <div class="text-center mt-4">
                <button onclick="CallosCareApp.showFullProtocol('${contentKey}')" 
                        class="bg-${color}-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-${color}-700 transition-colors inline-flex items-center">
                    <i class="fas fa-book-open mr-2"></i>Ver Tratamento Completo
                </button>
            </div>
        ` : '';
        
        return `
            <div class="p-4 border-l-4 ${colorClasses[color]} rounded-lg mb-4 prose max-w-none">
                <h3 class="font-bold text-center text-lg mb-3">
                    ${iconHtml}${content.title || defaultTitle}
                </h3>
                <div class="text-left">${this.processProductMarkers(content.content_html)}</div>
                ${seeMoreBtn}
            </div>
        `;
    },

    // =============================================
    // FUN√á√ïES AUXILIARES (MANTIDAS)
    // =============================================

    generateSmartSuggestedProducts(diagnosis, suggestedProductsSet) {
        // 1. Produtos baseados no tipo de p√©
        if (diagnosis.footType === 'seco') {
            this.addProductsByCategory('Hidrata√ß√£o', suggestedProductsSet);
        } else if (diagnosis.footType === 'humido') {
            this.addProductsByCategory('Controlo Humidade', suggestedProductsSet);
        }

        // 2. Produtos para inflama√ß√£o/dor
        if (diagnosis.inflammation || diagnosis.painLevel >= 7) {
            this.addProductsByCategory('Inflama√ß√£o Dor', suggestedProductsSet);
        }

        // 3. Produtos baseados nas regras inteligentes
        if (this.state.appConfig.suggestion_rules) {
            this.state.appConfig.suggestion_rules.forEach(rule => {
                if (this.checkRuleConditions(rule.conditions, diagnosis)) {
                    rule.products_to_suggest.forEach(category => {
                        this.addProductsByCategory(category, suggestedProductsSet);
                    });
                }
            });
        }

        // 4. Produtos de prote√ß√£o sempre √∫teis
        this.addProductsByCategory('Prote√ß√£o', suggestedProductsSet);
        
        // 5. Produtos baseados no tipo de calo
        if (diagnosis.callusType) {
            const callusTypeKey = diagnosis.callusType.toLowerCase().replace(/ /g, '_');
            this.state.appConfig.interactive_products?.forEach(product => {
                if (product.for_callus_types?.includes(callusTypeKey)) {
                    suggestedProductsSet.add(product.product_name);
                }
            });
        }
    },

    addProductsByCategory(category, productsSet) {
        const categoryProducts = this.state.appConfig.interactive_products?.filter(p => 
            p.category === category
        ) || [];
        
        categoryProducts.forEach(product => {
            productsSet.add(product.product_name);
        });
    },

    checkRuleConditions(conditions, diagnosis) {
        for (const [key, value] of Object.entries(conditions)) {
            switch (key) {
                case 'locations':
                    if (!value.some(loc => diagnosis.locations?.includes(loc))) {
                        return false;
                    }
                    break;
                case 'physicalChanges':
                    if (!value.some(change => diagnosis.physicalChanges?.includes(change))) {
                        return false;
                    }
                    break;
                case 'footType':
                    if (diagnosis.footType !== value) {
                        return false;
                    }
                    break;
                case 'painLevel':
                    if (diagnosis.painLevel < value) {
                        return false;
                    }
                    break;
                case 'hasDeformity':
                    if (diagnosis.hasDeformity !== value) {
                        return false;
                    }
                    break;
                case 'callusType':
                    if (diagnosis.callusType !== value) {
                        return false;
                    }
                    break;
            }
        }
        return true;
    },

    getCallusProtocolKey(callusType) {
        const mappings = {
            'Calo Duro': 'calo_duro_protocol',
            'Calo Mole': 'calo_mole_protocol',
            'Calosidade': 'calosidade_protocol',
            'Olho-de-peixe': 'verruga_protocol',
	    'Calo Semente': 'calo_semente_protocol' 
        };
        return mappings[callusType] || (callusType.toLowerCase().replace(/ /g, '_') + '_protocol');
    },

    formatLocations(locations) {
        if (!locations || locations.length === 0) return 'N√£o especificada';
        
        const locNames = {
            'dedo_grande': 'Dedo Grande', 
            'dedo_pequeno': 'Dedo Pequeno', 
            'entre_dedos': 'Entre os Dedos', 
            'em_cima_dedos': 'Em Cima dos Dedos',
            'bola_pe': 'Bola do P√©', 
            'calcanhar': 'Calcanhar', 
            'lateral': 'Lateral do P√©'
        };
        
        return locations.map(loc => locNames[loc] || loc).join(', ');
    },

    formatFootType(footType) {
        const types = {
            'seco': 'P√©s Secos',
            'humido': 'P√©s H√∫midos',
            'normal': 'P√©s Normais'
        };
        return types[footType] || 'N√£o especificado';
    },

    // =============================================
    // SISTEMA DE PRODUTOS (ATUALIZADO V5.0)
    // =============================================

    showProductSelection(category) {
        const categoryProducts = this.state.appConfig.interactive_products?.filter(p => 
            p.category === category
        ) || [];
        
        if (categoryProducts.length === 0) return;

        const currentSelections = this.state.diagnosis.selectedProducts?.[category] || [];
        const suggestedProducts = categoryProducts.slice(0, 3).map(p => p.product_name); // Top 3 sugeridos

        const modal = document.createElement('div');
        modal.className = 'modal temp-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <span onclick="this.parentElement.parentElement.remove()" class="float-right text-2xl font-bold cursor-pointer">&times;</span>
                <h3 class="text-xl font-bold mb-4">Selecionar Produtos - ${category}</h3>
                <p class="text-gray-600 mb-4">Produtos sugeridos est√£o pr√©-selecionados. Selecione/desmarque conforme desejar.</p>
                
                <div class="space-y-3 max-h-96 overflow-y-auto">
                    ${categoryProducts.map(product => {
                        const isSuggested = suggestedProducts.includes(product.product_name);
                        const isSelected = currentSelections.includes(product.product_name) || isSuggested;
                        return `
                            <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" 
                                       value="${product.product_name}"
                                       ${isSelected ? 'checked' : ''}
                                       class="mr-3 h-5 w-5 text-blue-600 product-checkbox">
                                <div>
                                    <div class="font-medium">${product.product_name}</div>
                                    ${product.description ? `<div class="text-sm text-gray-500">${product.description}</div>` : ''}
                                    ${isSuggested ? `<div class="text-xs text-blue-600 mt-1">‚úì Sugerido</div>` : ''}
                                </div>
                            </label>
                        `;
                    }).join('')}
                </div>
                
                <div class="flex justify-between items-center mt-6">
                    <span class="text-sm text-gray-500">Selecione m√∫ltiplos produtos se desejar</span>
                    <button onclick="CallosCareApp.confirmProductSelection('${category}')" 
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                        Confirmar Sele√ß√£o
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        modal.style.display = 'block';
    },

    confirmProductSelection(category) {
        const checkboxes = document.querySelectorAll('.product-checkbox:checked');
        const selectedProducts = Array.from(checkboxes).map(cb => cb.value);
        
        if (!this.state.diagnosis.selectedProducts) {
            this.state.diagnosis.selectedProducts = {};
        }
        
        if (selectedProducts.length > 0) {
            this.state.diagnosis.selectedProducts[category] = selectedProducts;
        } else {
            delete this.state.diagnosis.selectedProducts[category];
        }
        
        document.querySelector('.temp-modal')?.remove();
        this.render();
    },

    showFullProductCatalog() {
        const products = this.state.appConfig.interactive_products || [];
        const categories = [...new Set(products.map(p => p.category))].filter(Boolean);
        
        const modal = document.createElement('div');
        modal.className = 'modal temp-modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <span onclick="this.parentElement.parentElement.remove()" class="float-right text-2xl font-bold cursor-pointer">&times;</span>
                <h3 class="text-2xl font-bold mb-6 text-center">Cat√°logo Completo de Produtos</h3>
                
                ${categories.map(category => {
                    const categoryProducts = products.filter(p => p.category === category);
                    return `
                        <div class="mb-6">
                            <h4 class="font-bold text-lg mb-3 border-b pb-2">${category}</h4>
                            <div class="grid grid-cols-1 gap-3">
                                ${categoryProducts.map(product => `
                                    <div class="border border-gray-200 rounded-lg p-4">
                                        <h5 class="font-bold text-md mb-1">${product.product_name}</h5>
                                        ${product.description ? `<p class="text-sm text-gray-600 mb-2">${product.description}</p>` : ''}
                                        <button onclick="CallosCareApp.addProductToSelection('${product.product_name}', '${product.category}')" 
                                                class="text-blue-600 text-sm underline mt-2">
                                            Adicionar √† minha lista
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('')}
                
                <div class="text-center mt-6">
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg">
                        Fechar Cat√°logo
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        modal.style.display = 'block';
    },

    addProductToSelection(productName, category) {
        if (!this.state.diagnosis.selectedProducts) {
            this.state.diagnosis.selectedProducts = {};
        }
        
        if (!this.state.diagnosis.selectedProducts[category]) {
            this.state.diagnosis.selectedProducts[category] = [];
        }
        
        if (!this.state.diagnosis.selectedProducts[category].includes(productName)) {
            this.state.diagnosis.selectedProducts[category].push(productName);
        }
        
        document.querySelector('.temp-modal')?.remove();
        this.render();
    },

    removeProductFromSelection(productName) {
        if (!this.state.diagnosis.selectedProducts) return;
        
        for (const [category, products] of Object.entries(this.state.diagnosis.selectedProducts)) {
            const index = products.indexOf(productName);
            if (index > -1) {
                products.splice(index, 1);
                if (products.length === 0) {
                    delete this.state.diagnosis.selectedProducts[category];
                }
                break;
            }
        }
        
        this.render();
    },

    getAllSelectedProducts() {
        const d = this.state.diagnosis;
        if (!d.selectedProducts) return [];
        return Object.values(d.selectedProducts).flat();
    },

    getProductCategory(productName) {
        const product = this.state.appConfig.interactive_products?.find(p => 
            p.product_name === productName
        );
        return product?.category || 'outros';
    },

    // =============================================
    // FUN√á√ïES DE UI (MANTIDAS)
    // =============================================

    showSpinner(id) { 
        const el = document.getElementById(id); 
        if(el) { 
            el.classList.remove('hidden'); 
            const btn = el.parentElement; 
            if(btn) btn.setAttribute('disabled', 'true'); 
        } 
    },
    
    hideSpinner(id) { 
        const el = document.getElementById(id); 
        if(el) { 
            el.classList.add('hidden'); 
            const btn = el.parentElement; 
            if(btn) btn.removeAttribute('disabled'); 
        } 
    },
    
    showImageZoom(event, imageUrl) { 
        event.stopPropagation(); 
        document.getElementById('zoomed-image').src = imageUrl; 
        document.getElementById('image-zoom-modal').style.display = 'flex'; 
    },
    
    showDefinition(event, contentKey) {
        event.stopPropagation();
        const item = this.state.appConfig.app_content.find(c => c.content_key === contentKey);
        if(item) {
            document.getElementById('definition-title').innerText = item.title;
            document.getElementById('definition-text').innerHTML = item.content_html;
            document.getElementById('definition-modal').style.display = 'block';
        }
    },
    
    closeModal() { 
        document.getElementById('image-zoom-modal').style.display = 'none'; 
        document.getElementById('definition-modal').style.display = 'none'; 
        document.querySelectorAll('.modal').forEach(modal => {
            if(modal.id !== 'image-zoom-modal' && modal.id !== 'definition-modal') {
                modal.remove();
            }
        });
    },

    updateProgressBar() {
        const pbc = document.getElementById('progress-bar-container'),
              pb = document.getElementById('progress-bar');
        if(!pbc || !pb) return;
        
        const sm = {
            'step0_triage': 5,
            'step1_callusType': 15,
            'step2_location': 30,
            'step3_details': 45,
            'step4_footType': 60,
            'step5_results': 75,
            'step6_investigation': 85,
            'step7_investigation_results': 95
        };
        
        const p = sm[this.state.currentStep] || 0;
        if(p > 0){
            pbc.classList.remove('hidden');
            pb.style.width = `${p}%`;
        } else {
            pbc.classList.add('hidden');
        }
    },

    ensureDisinfectionProducts() {
        const disinfectionProducts = [
            { product_name: "Povidona-iodada", category: "Desinfec√ß√£o", description: "Antiss√©ptico para desinfetar a √°rea antes do tratamento" },
            { product_name: "Clorexidina", category: "Desinfec√ß√£o", description: "Solu√ß√£o antiss√©ptica para higiene dos p√©s" },
            { product_name: "√Ålcool 70¬∫", category: "Desinfec√ß√£o", description: "Para desinfetar utens√≠lios e superf√≠cies" }
        ];
        if (this.state.appConfig.interactive_products) {
            disinfectionProducts.forEach(newProduct => {
                const exists = this.state.appConfig.interactive_products.some(p => p.product_name === newProduct.product_name);
                if (!exists) this.state.appConfig.interactive_products.push(newProduct);
            });
        }
    },

    // =============================================
    // RENDER PRINCIPAL (ATUALIZADO V5.0)
    // =============================================

    render() {
        this.updateProgressBar();
        const container = document.getElementById('calloscare-main-content');
        let content = '';
        const d = this.state.diagnosis;
        
        document.getElementById('app-title').innerHTML = `CallosCare <span class="text-sm font-light opacity-75">${this.VERSION}</span>`;
        
        const warningBanner = document.getElementById('diabetic-warning-banner');
        if (d && d.is_diabetic && this.state.currentStep.startsWith('step')) { 
            if(warningBanner) warningBanner.classList.remove('hidden'); 
        } else { 
            if(warningBanner) warningBanner.classList.add('hidden'); 
        }

        switch (this.state.currentStep) {
            case 'loading': 
                content = `<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i></div>`; 
                break;
                
            case 'error': 
                content = `<div class="text-center p-8 text-red-500">Ocorreu um erro ao carregar. Tente recarregar a p√°gina.</div>`; 
                break;
                
            case 'identification':
                content = `
                    <div class="max-w-lg mx-auto">
                        <h2 class="text-2xl font-semibold text-center mb-4">Identifica√ß√£o do Paciente</h2>
                        <p class="text-center text-gray-600 mb-6">Para guardar o seu progresso, preencha os seus dados.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="user-first-name" class="block text-sm font-medium text-gray-700">Primeiro Nome*</label>
                                <input type="text" id="user-first-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="user-last-name" class="block text-sm font-medium text-gray-700">√öltimo Nome*</label>
                                <input type="text" id="user-last-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="user-email" class="block text-sm font-medium text-gray-700">Email*</label>
                                <input type="email" id="user-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="flex justify-end mt-6">
                            <button onclick="CallosCareApp.saveUser()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">
                                Guardar e Entrar <i id="save-client-spinner" class="fas fa-spinner fa-spin hidden ml-2"></i>
                            </button>
                        </div>
                    </div>`;
                break;
                
            case 'home':
                content = `
                    <div class="max-w-md mx-auto text-center">
                        <h2 class="text-2xl font-semibold mb-2">Bem-vindo(a), ${this.state.user?.firstName || 'Utilizador'}!</h2>
                        <p class="text-gray-600 mb-8">Como podemos ajud√°-lo hoje?</p>
                        <div class="space-y-4 mt-8">
                            <button onclick="CallosCareApp.startDiagnosis()" class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-lg text-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-plus-circle mr-3"></i> Iniciar Novo Diagn√≥stico
                            </button>
                            <button onclick="alert('Hist√≥rico ser√° implementado na pr√≥xima vers√£o.')" class="w-full bg-gray-600 text-white font-bold py-4 px-6 rounded-lg text-lg hover:bg-gray-700 transition-colors">
                                <i class="fas fa-history mr-3"></i> Aceder ao Hist√≥rico
                            </button>
                        </div>
                    </div>`;
                break;
                
            case 'step0_triage':
    const warning = this.state.appConfig.app_content?.find(c => c.content_key === 'diabetes_warning_page');
    const isDiabetic = this.state.diagnosis.is_diabetic;
    
    content = `
        <div>
            <h2 class="text-2xl font-semibold text-center mb-6">Pergunta Importante de Seguran√ßa</h2>
            <div class="max-w-lg mx-auto space-y-4">
                <label class="block text-lg font-bold text-gray-700">√â diab√©tico ou tem neuropatia/m√° circula√ß√£o sangu√≠nea?</label>
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button class="calloscare-btn p-4 rounded-lg border-2 border-red-500 text-red-700 hover:bg-red-50 transition-colors ${isDiabetic === true ? 'selected bg-red-100' : ''}" 
                            onclick="CallosCareApp.selectOption('is_diabetic', true)">
                        Sim
                    </button>
                    <button class="calloscare-btn p-4 rounded-lg border-2 border-green-500 text-green-700 hover:bg-green-50 transition-colors ${isDiabetic === false ? 'selected bg-green-100' : ''}" 
                            onclick="CallosCareApp.selectOption('is_diabetic', false); CallosCareApp.goToStep('step1_callusType');">
                        N√£o
                    </button>
                </div>
                ${isDiabetic === true && warning ? `
                    <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <h3 class="font-bold text-yellow-800 mb-2">‚ö†Ô∏è Aviso Importante para Diab√©ticos</h3>
                        <div class="text-yellow-700">${warning.content_html}</div>
                    </div>
                    <div class="flex justify-between mt-8">
                        <button onclick="CallosCareApp.goToStep('home')" 
                                class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            Voltar ao Menu
                        </button>
                        <button onclick="CallosCareApp.goToStep('step1_callusType')" 
                                class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            Compreendo os riscos, desejo continuar
                        </button>
                    </div>
                ` : ''}
                ${isDiabetic === true && !warning ? `
                    <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <h3 class="font-bold text-yellow-800 mb-2">‚ö†Ô∏è Aviso Importante</h3>
                        <p class="text-yellow-700">Como diab√©tico ou pessoa com problemas de circula√ß√£o, o auto-tratamento apresenta riscos adicionais. Consulte sempre um profissional de sa√∫de antes de proceder.</p>
                    </div>
                    <div class="flex justify-between mt-8">
                        <button onclick="CallosCareApp.goToStep('home')" 
                                class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            Voltar ao Menu
                        </button>
                        <button onclick="CallosCareApp.goToStep('step1_callusType')" 
                                class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            Compreendo, desejo continuar
                        </button>
                    </div>
                ` : ''}
            </div>
        </div>`;
    break;
                
            case 'step1_callusType':
                const types = this.state.appConfig.app_content.filter(c => c.content_key.endsWith('_definition')) || [];
                content = `
                    <h2 class="text-2xl font-semibold text-center mb-6">Passo 1: Qual o aspeto da les√£o?</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        ${types.map(t => {
                            const typeName = t.title.replace('O que √© um ','').replace('?','');
                            return `
                                <div class="calloscare-option-card border-2 p-3 text-center rounded-lg flex flex-col justify-between ${d.callusType===typeName?'selected border-blue-500':''}" 
                                     onclick="this.parentElement.querySelectorAll('.selected').forEach(e=>e.classList.remove('selected'));this.classList.add('selected');CallosCareApp.selectCallusType('${t.content_key}')">
                                    <img src="${t.image_url || ''}" class="w-full h-32 object-cover rounded-md mb-2 bg-gray-200 cursor-pointer" 
                                         onclick="CallosCareApp.showImageZoom(event, '${t.image_url || ''}')">
                                    <div>
                                        <p class="font-semibold text-blue-600 underline cursor-pointer" onclick="CallosCareApp.showDefinition(event, '${t.content_key}')">
                                            ${typeName}
                                        </p>
                                        <p class="text-xs text-gray-500 mt-1">${t.short_desc || ''}</p>
                                    </div>
                                </div>`
                        }).join('')}
                    </div>
                    <div class="flex justify-between mt-8">
                        <button onclick="CallosCareApp.goToStep(CallosCareApp.state.diagnosis.is_diabetic ? 'step0_triage' : 'home')" 
                                class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            Voltar
                        </button>
                        <button class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg step-next-btn hover:bg-blue-700 transition-colors ${!d.callusType?'opacity-50 cursor-not-allowed':''}" 
                                onclick="CallosCareApp.goToStep('step2_location')" ${!d.callusType?'disabled':''}>
                            Pr√≥ximo
                        </button>
                    </div>`;
                break;
                
            case 'step2_location':
                const locations = [ 
                    {id:"dedo_grande",text:"1. Dedo Grande"},
                    {id:"dedo_pequeno",text:"2. Dedo Pequeno"},
                    {id:"entre_dedos",text:"3. Entre os Dedos"},
                    {id:"em_cima_dedos",text:"4. Em Cima dos Dedos"},
                    {id:"bola_pe",text:"5. Bola do P√©"},
                    {id:"calcanhar",text:"6. Calcanhar"},
                    {id:"lateral",text:"7. Lateral do P√©"}
                ];
                content = `
                    <h2 class="text-2xl font-semibold text-center mb-6">Passo 2: Onde se localiza a dor?</h2>
                    <p class="text-center text-gray-600 mb-4">Selecione uma ou mais zonas.</p>
                    <div class="flex flex-col md:flex-row gap-8 items-start mt-6">
                        <div class="w-full md:w-5/12">
                            <img src="https://calos.webbizs.com/web/image/10582-43516c77/p%C3%A9%20desenho.webp" alt="Diagrama do P√©" class="w-full max-w-xs mx-auto">
                        </div>
                        <div class="w-full md:w-7/12 grid grid-cols-1 gap-2">
                            ${locations.map(loc => `
                                <button class="calloscare-btn w-full text-left border border-gray-300 p-3 rounded-lg hover:bg-gray-50 transition-colors ${(d.locations||[]).includes(loc.id)?'selected bg-blue-100 border-blue-500':''}" 
                                        onclick="CallosCareApp.toggleMultiOption('locations','${loc.id}')">
                                    ${loc.text}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    <div class="flex justify-between mt-8">
                        <button onclick="CallosCareApp.goToStep('step1_callusType')" 
                                class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            Voltar
                        </button>
                        <button onclick="CallosCareApp.goToStep('step3_details')" 
                                class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg step-next-btn hover:bg-blue-700 transition-colors ${!d.locations||d.locations.length===0?'opacity-50 cursor-not-allowed':''}" 
                                ${!d.locations||d.locations.length===0?'disabled':''}>
                            Pr√≥ximo
                        </button>
                    </div>`;
                break;
                
            case 'step3_details':
                const changes = [
                    {id:'aumento_peso', text:'Aumento de peso'}, 
                    {id:'incha√ßo', text:'Incha√ßo (Edema) nos p√©s'}, 
                    {id:'nenhum', text:'Nenhuma das anteriores'}
                ];
                content = `
                    <h2 class="text-2xl font-semibold text-center mb-6">Passo 3: Detalhes dos Sintomas</h2>
                    <div class="max-w-lg mx-auto space-y-8">
                        <div>
                            <label class="block text-lg font-bold text-gray-700">Classifique o seu N√≠vel de Dor</label>
                            <input type="range" id="pain-level-slider" min="0" max="10" value="${d.painLevel||0}" 
                                   class="w-full h-3 mt-2" 
                                   oninput="document.getElementById('pain-level-display').textContent=this.value" 
                                   onchange="CallosCareApp.selectOption('painLevel',this.value,'inflammation-yes-btn')">
                            <div class="flex justify-between text-sm text-gray-500 mt-1 px-1">
                                <span>0</span><span>10</span>
                            </div>
                            <p class="text-center text-3xl font-bold mt-2" id="pain-level-display">${d.painLevel||0}</p>
                        </div>
                        <div>
                            <label class="block text-lg font-bold text-gray-700">A zona est√° inflamada (vermelha, quente)?</label>
                            <div class="mt-2 grid grid-cols-2 gap-4">
                                <button id="inflammation-yes-btn" 
                                        class="calloscare-btn p-4 rounded-lg border hover:bg-gray-50 transition-colors ${d.inflammation===true?'selected bg-blue-100 border-blue-500':''}" 
                                        onclick="this.parentElement.querySelectorAll('.selected').forEach(e=>e.classList.remove('selected'));this.classList.add('selected');CallosCareApp.selectOption('inflammation',true,'#physical-changes-group button')">
                                    Sim
                                </button>
                                <button class="calloscare-btn p-4 rounded-lg border hover:bg-gray-50 transition-colors ${d.inflammation===false?'selected bg-blue-100 border-blue-500':''}" 
                                        onclick="this.parentElement.querySelectorAll('.selected').forEach(e=>e.classList.remove('selected'));this.classList.add('selected');CallosCareApp.selectOption('inflammation',false,'#physical-changes-group button')">
                                    N√£o
                                </button>
                            </div>
                        </div>
                        <div id="physical-changes-group">
                            <label class="block text-lg font-bold text-gray-700 mb-2">Notou alguma altera√ß√£o f√≠sica recente?</label>
                            <div class="space-y-2">
                                ${changes.map(c => `
                                    <button class="physicalChanges-btn calloscare-btn w-full text-left border p-3 rounded-lg hover:bg-gray-50 transition-colors ${(d.physicalChanges||[]).includes(c.id)?'selected bg-blue-100 border-blue-500':''}" 
                                            data-value="${c.id}" 
                                            onclick="this.classList.toggle('selected');CallosCareApp.toggleMultiOption('physicalChanges','${c.id}',${c.id==='nenhum'})">
                                        ${c.text}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between mt-8">
                        <button onclick="CallosCareApp.goToStep('step2_location')" 
                                class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            Voltar
                        </button>
                        <button onclick="CallosCareApp.goToStep('step4_footType')" 
                                class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg step-next-btn hover:bg-blue-700 transition-colors ${d.painLevel===undefined||d.inflammation===undefined||!d.physicalChanges||d.physicalChanges.length===0?'opacity-50 cursor-not-allowed':''}" 
                                ${d.painLevel===undefined||d.inflammation===undefined||!d.physicalChanges||d.physicalChanges.length===0?'disabled':''}>
                            Pr√≥ximo
                        </button>
                    </div>`;
                break;
                
            case 'step4_footType':
                const footTypes = [
                    {id:"seco",title:"P√©s Secos",desc:"A pele parece repuxada..."},
                    {id:"humido",title:"P√©s H√∫midos / Suados",desc:"Os p√©s transpiram com frequ√™ncia."},
                    {id:"normal",title:"P√©s Normais",desc:"A pele √© macia..."}
                ];
                content = `
                    <h2 class="text-2xl font-semibold text-center mb-6">Passo 4: An√°lise Final</h2>
                    <div class="max-w-lg mx-auto space-y-8">
                        <div>
                            <label class="block text-lg font-bold text-gray-700">Qual o seu tipo de p√©s?</label>
                            <div class="mt-2 space-y-3">
                                ${footTypes.map(ft => `
                                    <button class="calloscare-btn w-full text-left border p-4 rounded-lg hover:bg-gray-50 transition-colors ${d.footType===ft.id?'selected bg-blue-100 border-blue-500':''}" 
                                            onclick="this.parentElement.querySelectorAll('.selected').forEach(e=>e.classList.remove('selected'));this.classList.add('selected');CallosCareApp.selectOption('footType','${ft.id}','deformity-yes-btn')">
                                        <strong class="block">${ft.title}</strong>
                                        <span class="text-sm text-gray-500">${ft.desc}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <div>
                            <label class="block text-lg font-bold text-gray-700">Tem alguma deformidade vis√≠vel no p√©?</label>
                            <p class="text-sm text-gray-500 mb-2">(ex: dedos curvados, joanete, etc.)</p>
                            <div class="mt-2 grid grid-cols-2 gap-4">
                                <button id="deformity-yes-btn" 
                                        class="calloscare-btn p-4 rounded-lg border hover:bg-gray-50 transition-colors ${d.hasDeformity===true?'selected bg-blue-100 border-blue-500':''}" 
                                        onclick="this.parentElement.querySelectorAll('.selected').forEach(e=>e.classList.remove('selected'));this.classList.add('selected');CallosCareApp.selectOption('hasDeformity',true)">
                                    Sim
                                </button>
                                <button class="calloscare-btn p-4 rounded-lg border hover:bg-gray-50 transition-colors ${d.hasDeformity===false?'selected bg-blue-100 border-blue-500':''}" 
                                        onclick="this.parentElement.querySelectorAll('.selected').forEach(e=>e.classList.remove('selected'));this.classList.add('selected');CallosCareApp.selectOption('hasDeformity',false)">
                                    N√£o
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between mt-8">
                        <button onclick="CallosCareApp.goToStep('step3_details')" 
                                class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            Voltar
                        </button>
                        <button onclick="CallosCareApp.generateAndGoToResults()" 
                                class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg step-next-btn hover:bg-green-700 transition-colors ${!d.footType||d.hasDeformity===undefined?'opacity-50 cursor-not-allowed':''}" 
                                ${!d.footType||d.hasDeformity===undefined?'disabled':''}>
                            Ver Tratamento Sugerido
                        </button>
                    </div>`;
                break;
                
            case 'step5_results':
                const results = this.generateTreatmentHtml(d);
                const selectedProducts = this.getAllSelectedProducts();
                
                content = `
                    <h2 class="text-2xl font-semibold text-center mb-6">Plano de Tratamento Individualizado</h2>
                    
                    <div id="treatment-results-content" class="space-y-6">
                        ${results.fullHtml}
                    </div>
                    
                    <!-- LISTA DE PRODUTOS SUGERIDOS - V5.0 MELHORADA -->
                    <div class="mt-8 p-6 bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-bold text-lg text-gray-800">üõçÔ∏è Lista de Produtos Sugeridos</h4>
                            <button onclick="CallosCareApp.showFullProductCatalog()" 
                                    class="text-blue-600 text-sm underline hover:text-blue-800 transition-colors">
                                (veja toda a lista de produtos)
                            </button>
                        </div>
                        
                        <!-- Produtos Selecionados pelo Utilizador -->
                        ${selectedProducts.length > 0 ? `
                            <div class="mb-4">
                                <p class="text-sm text-gray-600 mb-2">‚úÖ <strong>Os seus produtos selecionados:</strong></p>
                                <ul class="list-disc pl-5 space-y-1">
                                    ${selectedProducts.map(p => `<li class="text-green-600 font-medium">${p} 
                                        <button onclick="CallosCareApp.removeProductFromSelection('${p.replace(/'/g, "\\'")}')" 
                                                class="ml-2 text-red-600 text-xs underline hover:text-red-800">
                                            remover
                                        </button>
                                    </li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        <!-- Produtos Sugeridos pelo Sistema -->
                        <div>
                            <p class="text-sm text-gray-600 mb-2"><strong>üõí Produtos sugeridos pelo sistema:</strong></p>
                            <ul class="list-disc pl-5 space-y-1 text-left">
                                ${(d.suggestedProducts && d.suggestedProducts.length > 0) ? 
                                    d.suggestedProducts.map(p => `
                                        <li class="${selectedProducts.includes(p) ? 'text-green-600 font-medium' : 'text-gray-700'}">
                                            ${p}
                                            ${!selectedProducts.includes(p) ? `
                                                <button onclick="CallosCareApp.addProductToSelection('${p.replace(/'/g, "\\'")}', '${this.getProductCategory(p).replace(/'/g, "\\'")}')" 
                                                        class="ml-2 text-blue-600 text-xs underline hover:text-blue-800">
                                                    adicionar
                                                </button>
                                            ` : `
                                                <button onclick="CallosCareApp.removeProductFromSelection('${p.replace(/'/g, "\\'")}')" 
                                                        class="ml-2 text-red-600 text-xs underline hover:text-red-800">
                                                    remover
                                                </button>
                                            `}
                                        </li>
                                    `).join('') : 
                                    '<li class="text-gray-500">Nenhum produto espec√≠fico sugerido.</li>'
                                }
                            </ul>
                        </div>
                    </div>
                    
                    <!-- BOT√ïES DE A√á√ÉO -->
                    <div class="flex justify-between items-center mt-8">
                        ${d.isSaved ? `
                            <span class="text-green-600 font-bold flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>Diagn√≥stico Guardado ‚úì
                            </span>
                            <div class="space-x-4">
                                <button onclick="CallosCareApp.startCauseInvestigation()" 
                                        class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition-colors">
                                    Investigar Causa Raiz
                                </button>
                                <button onclick="CallosCareApp.goToStep('home')" 
                                        class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">
                                    Voltar ao Menu Principal
                                </button>
                            </div>
                        ` : `
                            <button onclick="CallosCareApp.goToStep('step4_footType')" 
                                    class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                                ‚Üê Voltar e Editar
                            </button>
                            <div class="space-x-4">
                                <button onclick="CallosCareApp.startCauseInvestigation()" 
                                        class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition-colors">
                                    Investigar Causa Raiz
                                </button>
                                <button onclick="CallosCareApp.saveDiagnosis()" 
                                        class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors flex items-center">
                                    Guardar Diagn√≥stico 
                                    <i id="save-diag-spinner" class="fas fa-spinner fa-spin hidden ml-2"></i>
                                </button>
                            </div>
                        `}
                    </div>`;
                break;
                
            case 'step6_investigation':
                const currentQuestion = this.getCurrentInvestigationQuestion();
                if (!currentQuestion) {
                    this.goToStep('step7_investigation_results');
                    return;
                }

                content = `
                    <h2 class="text-2xl font-semibold text-center mb-6">Investiga√ß√£o da Causa Raiz</h2>
                    
                    <div class="max-w-2xl mx-auto">
                        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">Pergunta ${this.state.investigation.currentQuestion + 1} de ${this.getTotalInvestigationQuestions()}</h3>
                                <span class="text-sm text-gray-500">${this.getCurrentInvestigationGroup()?.category || 'Investiga√ß√£o'}</span>
                            </div>
                            
                            <p class="text-xl text-gray-700 mb-8 leading-relaxed">${currentQuestion.question_text}</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button onclick="CallosCareApp.answerInvestigationQuestion(true)" 
                                        class="investigation-option bg-red-50 border border-red-200 text-red-700 p-6 rounded-lg hover:bg-red-100 hover:border-red-300 transition-all">
                                    <div class="text-center">
                                        <i class="fas fa-times text-2xl mb-2"></i>
                                        <div class="font-semibold">Sim</div>
                                        <div class="text-sm mt-1">Esta pode ser a causa</div>
                                    </div>
                                </button>
                                
                                <button onclick="CallosCareApp.answerInvestigationQuestion(false)" 
                                        class="investigation-option bg-green-50 border border-green-200 text-green-700 p-6 rounded-lg hover:bg-green-100 hover:border-green-300 transition-all">
                                    <div class="text-center">
                                        <i class="fas fa-check text-2xl mb-2"></i>
                                        <div class="font-semibold">N√£o</div>
                                        <div class="text-sm mt-1">N√£o se aplica</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button onclick="CallosCareApp.goToStep('step5_results')" 
                                    class="text-gray-600 underline hover:text-gray-800 transition-colors">
                                ‚Üê Voltar ao Plano de Tratamento
                            </button>
                        </div>
                    </div>`;
                break;
                
            case 'step7_investigation_results':
                const recommendations = this.state.investigation.recommendations;
                
                content = `
                    <h2 class="text-2xl font-semibold text-center mb-6">Resultados da Investiga√ß√£o</h2>
                    
                    <div class="max-w-2xl mx-auto">
                        ${recommendations.length > 0 ? `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
                                <h3 class="text-lg font-semibold text-yellow-800 mb-4 flex items-center">
                                    <i class="fas fa-lightbulb mr-2"></i>
                                    Poss√≠veis Causas Identificadas
                                </h3>
                                <div class="space-y-4">
                                    ${recommendations.map(rec => `
                                        <div class="bg-white rounded-lg p-4 border border-yellow-100">
                                            <h4 class="font-semibold text-gray-800 mb-2">${rec.question}</h4>
                                            <p class="text-gray-700">${rec.advice}</p>
                                            ${rec.products.length > 0 ? `
                                                <div class="mt-3">
                                                    <p class="text-sm text-gray-600 font-medium">Produtos recomendados:</p>
                                                    <ul class="list-disc pl-5 mt-1 text-sm text-gray-700">
                                                        ${rec.products.map(product => `<li>${product}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : `
                            <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6 text-center">
                                <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
                                <h3 class="text-lg font-semibold text-green-800 mb-2">Excelente!</h3>
                                <p class="text-green-700">N√£o foram identificadas causas espec√≠ficas relacionadas com cal√ßado ou h√°bitos. Continue com o plano de tratamento recomendado.</p>
                            </div>
                        `}
                        
                        <div class="text-center space-y-4">
                            <button onclick="CallosCareApp.goToStep('step5_results')" 
                                    class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors">
                                ‚Üê Voltar ao Plano de Tratamento
                            </button>
                            <div>
                                <button onclick="CallosCareApp.goToStep('home')" 
                                        class="text-gray-600 underline hover:text-gray-800 transition-colors">
                                    Ir para o Menu Principal
                                </button>
                            </div>
                        </div>
                    </div>`;
                break;
                
            default:
                content = `
                    <p class="text-center">
                        Ocorreu um erro de navega√ß√£o. 
                        <a href="#" onclick="CallosCareApp.goToStep('home')" class="text-blue-600 underline hover:text-blue-800">
                            Voltar ao in√≠cio.
                        </a>
                    </p>`;
                break;
        }
        
        container.innerHTML = `<div class="calloscare-step active">${content}</div>`;
        
        // Focar no primeiro elemento interativo quando apropriado
        if (['identification', 'step3_details'].includes(this.state.currentStep)) {
            setTimeout(() => {
                const firstInput = container.querySelector('input, button');
                if (firstInput) firstInput.focus();
            }, 100);
        }
    }
};

// Inicializa√ß√£o da aplica√ß√£o
document.addEventListener('DOMContentLoaded', () => CallosCareApp.init());

// Fechar modal ao clicar fora do conte√∫do
window.addEventListener('click', (event) => {
    if (event.target.classList.contains('modal')) {
        CallosCareApp.closeModal();
    }
});
</script>
</body>
</html>
