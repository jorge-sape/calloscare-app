<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CallosCare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        #calloscare-app-container { font-family: 'Inter', sans-serif; }
        .calloscare-step { display: none; }
        .calloscare-step.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
        .calloscare-option-card { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .calloscare-option-card:hover { transform: translateY(-5px); }
        .calloscare-option-card.selected { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); }
        .calloscare-btn.selected { background-color: #2563eb !important; color: white !important; }
        .calloscare-btn.selected span { color: white !important; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; } .prose li { margin-top: 0.5rem; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; }
        .zoom-modal .modal-content { background: transparent; border: none; padding: 0; max-width: 90vw; max-height: 90vh; }
        .zoom-modal img { width: 100%; height: 100%; object-fit: contain; }
    </style>
</head>
<body>

<div id="calloscare-app-container" class="max-w-4xl mx-auto bg-gray-50 p-4 sm:p-6 rounded-lg shadow-lg">
    <header class="text-center mb-6 bg-blue-600 p-4 rounded-lg shadow-md">
        <h1 id="app-title" class="text-3xl font-bold text-white">CallosCare</h1>
        <p class="text-md text-blue-100">Assistente de Diagnóstico e Tratamento da DOR e dos seus Calos</p>
    </header>
    <div id="diabetic-warning-banner" class="hidden p-3 mb-4 bg-red-100 border-l-4 border-red-500 text-red-700">
        <p><i class="fas fa-exclamation-triangle mr-2"></i><strong>Aviso:</strong> Como diabético/com má circulação, o auto-tratamento apresenta riscos. Use esta ferramenta como guia educativo e consulte sempre um profissional.</p>
    </div>
    <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5 mb-8 hidden">
        <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full progress-bar-fill" style="width: 0%"></div>
    </div>
    <main id="calloscare-main-content"></main>
</div>

<div id="image-zoom-modal" class="modal zoom-modal" onclick="CallosCareApp.closeModal()">
    <div class="modal-content"><img id="zoomed-image" src="" alt="Imagem Ampliada"></div>
</div>
<div id="definition-modal" class="modal">
    <div class="modal-content">
        <span onclick="CallosCareApp.closeModal()" class="float-right text-2xl font-bold cursor-pointer">&times;</span>
        <h2 id="definition-title" class="text-2xl font-bold mb-4"></h2>
        <div id="definition-text" class="text-gray-700 prose"></div>
    </div>
</div>

<script>
// CallosCare App v3.3
const CallosCareApp = {
    API_BASE_URL: '/api',
    VERSION: 'v3.3',
    state: { user: null, appConfig: null, currentStep: 'loading', diagnosis: {} },

    async init() {
        this.render();
        this.loadUserFromLocalStorage();
        try {
            this.state.appConfig = await this.api.getAppConfig();
            this.state.currentStep = this.state.user ? 'home' : 'identification';
        } catch (error) {
            this.state.currentStep = 'error';
        }
        this.render();
    },

    loadUserFromLocalStorage() {
        try { const u = localStorage.getItem('calloscareUser'); if(u) this.state.user = JSON.parse(u); } catch(e){}
    },
    
    // Todas as outras funções (saveUser, startDiagnosis, etc.) permanecem aqui na sua versão completa e funcional.
    // Para brevidade, apenas as funções alteradas são mostradas aqui.
    // O bloco de código final para copiar conterá TUDO.

    goToStep(step) {
        this.state.currentStep = step;
        window.scrollTo(0,0);
        this.render();
    },

    render() {
        const container = document.getElementById('calloscare-main-content');
        const warningBanner = document.getElementById('diabetic-warning-banner');
        
        // Controlo do banner de aviso
        if (this.state.diagnosis.is_diabetic && this.state.currentStep.startsWith('step')) {
            warningBanner.classList.remove('hidden');
        } else {
            warningBanner.classList.add('hidden');
        }
        
        let content = '';
        const d = this.state.diagnosis;

        switch (this.state.currentStep) {
            case 'loading': content=`<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i></div>`; break;
            case 'error': content=`<div class="text-center p-8 text-red-500">Ocorreu um erro ao carregar. Tente recarregar a página.</div>`; break;
            case 'identification': content=``; break;
            case 'home': content=``; break;
            case 'step0_triage':
                const warning = this.state.appConfig.app_content.find(c => c.content_key === 'diabetes_warning_page');
                content = `
                    <div class="calloscare-step active">
                        <h2 class="text-2xl font-semibold text-center mb-6">Pergunta Importante de Segurança</h2>
                        <div class="max-w-lg mx-auto space-y-4">
                            <label class="block text-lg font-bold text-gray-700">É diabético ou tem neuropatia/má circulação sanguínea?</label>
                            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button class="calloscare-btn p-4 rounded-lg border-2 border-red-500 text-red-700 hover:bg-red-50" onclick="CallosCareApp.state.diagnosis.is_diabetic=true; CallosCareApp.render();">Sim</button>
                                <button class="calloscare-btn p-4 rounded-lg border-2 border-green-500 text-green-700 hover:bg-green-50" onclick="CallosCareApp.state.diagnosis.is_diabetic=false; CallosCareApp.goToStep('step1_callusType')">Não</button>
                            </div>
                            ${d.is_diabetic === true && warning ? `<div class="mt-6">${warning.content_html}</div><div class="flex justify-between mt-8"><button onclick="CallosCareApp.goToStep('home')" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Voltar</button><button onclick="CallosCareApp.goToStep('step1_calloscareType')" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Compreendo, desejo continuar</button></div>` : ''}
                        </div>
                    </div>`;
                break;
            
            case 'step1_callusType':
                // O código para o passo 1 já não injeta o aviso de diabetes, pois ele agora é um banner separado
                const types = this.state.appConfig.app_content.filter(c => c.content_key.endsWith('_definition')) || [];
                content = `
                    <h2 class="text-2xl font-semibold text-center mb-6">Passo 1: Qual o aspeto da lesão?</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">${types.map(t => {
                        const typeName = t.title.replace('O que é um ','');
                        return `<div class="calloscare-option-card border-2 p-3 text-center rounded-lg flex flex-col justify-between" onclick="this.parentElement.querySelectorAll('.selected').forEach(e=>e.classList.remove('selected'));this.classList.add('selected');CallosCareApp.selectOption('callusType','${typeName}')">
                                    <img src="" class="w-full h-32 object-cover rounded-md mb-2 bg-gray-200">
                                    <div><p class="font-semibold text-blue-600 underline cursor-pointer" onclick="CallosCareApp.showDefinition(event,'${t.content_key}')">${typeName}</p></div>
                                </div>`
                    }).join('')}</div>
                    <div class="flex justify-between mt-8"><button onclick="CallosCareApp.goToStep('home')" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Voltar</button><button onclick="CallosCareApp.goToStep('step2_location')" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg step-next-btn" ${!d.callusType?'disabled':''}>Próximo</button></div>`;
                break;
            // Todos os outros passos...
            default:
                content = `<p class="text-center">Ocorreu um erro de navegação. <a href="#" onclick="CallosCareApp.goToStep('home')" class="text-blue-600">Voltar ao início.</a></p>`;
                break;
        }
        container.innerHTML = `<div class="calloscare-step active">${content}</div>`;
        document.getElementById('app-title').innerHTML = `CallosCare <span class="text-sm font-light opacity-75">${this.VERSION}</span>`;
    }
};

document.addEventListener('DOMContentLoaded', () => CallosCareApp.init());
</script>
</body>
</html>
