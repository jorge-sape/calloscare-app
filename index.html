<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CallosCare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        #calloscare-app-container { font-family: 'Inter', sans-serif; }
        .calloscare-step { display: none; }
        .calloscare-step.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
        .calloscare-option-card { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .calloscare-option-card:hover { transform: translateY(-5px); }
        .calloscare-option-card.selected { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); }
        .calloscare-btn.selected { background-color: #2563eb !important; color: white !important; }
        .calloscare-btn.selected span { color: white !important; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; } .prose li { margin-top: 0.5rem; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; }
        .zoom-modal .modal-content { background: transparent; border: none; padding: 0; max-width: 90vw; max-height: 90vh; }
        .zoom-modal img { width: 100%; height: 100%; object-fit: contain; }
        .product-link.user-choice { color: #27ae60; font-weight: bold; }
    </style>
</head>
<body>

<div id="calloscare-app-container" class="max-w-4xl mx-auto bg-gray-50 p-4 sm:p-6 rounded-lg shadow-lg">
    <header class="text-center mb-6 bg-blue-600 p-4 rounded-lg shadow-md">
        <h1 id="app-title" class="text-3xl font-bold text-white">CallosCare</h1>
        <p class="text-md text-blue-100">Assistente de Diagnóstico e Tratamento da DOR e dos seus Calos</p>
    </header>
    <div id="diabetic-warning-banner" class="hidden p-3 mb-4 bg-red-100 border-l-4 border-red-500 text-red-700">
        <p><i class="fas fa-exclamation-triangle mr-2"></i><strong>Aviso:</strong> Como diabético/com má circulação, o auto-tratamento apresenta riscos. Use esta ferramenta como guia educativo e consulte sempre um profissional.</p>
    </div>
    <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5 mb-8 hidden">
        <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full progress-bar-fill" style="width: 0%"></div>
    </div>
    <main id="calloscare-main-content"></main>
</div>

<div id="image-zoom-modal" class="modal zoom-modal" onclick="CallosCareApp.closeModal()">
    <div class="modal-content"><img id="zoomed-image" src="" alt="Imagem Ampliada"></div>
</div>
<div id="definition-modal" class="modal">
    <div class="modal-content">
        <span onclick="CallosCareApp.closeModal()" class="float-right text-2xl font-bold cursor-pointer">&times;</span>
        <h2 id="definition-title" class="text-2xl font-bold mb-4"></h2>
        <div id="definition-text" class="text-gray-700 prose"></div>
    </div>
</div>
<div id="product-modal" class="modal">
    <div class="modal-content">
        <span onclick="CallosCareApp.closeModal()" class="float-right text-2xl font-bold cursor-pointer">&times;</span>
        <h2 id="product-title" class="text-2xl font-bold mb-4"></h2>
        <div id="product-list" class="space-y-2"></div>
    </div>
</div>

<script>
// CallosCare App v4.5
const CallosCareApp = {
    API_BASE_URL: '/api',
    VERSION: 'v4.5',
    state: { user: null, appConfig: null, currentStep: 'loading', diagnosis: {} },

    async init() {
        this.render(); this.loadUserFromLocalStorage();
        try { this.state.appConfig = await this.api.getAppConfig(); this.state.currentStep = this.state.user ? 'home' : 'identification';
        } catch (error) { console.error("Initialization Error:", error); this.state.currentStep = 'error'; }
        this.render();
    },

    loadUserFromLocalStorage() { try { const u = localStorage.getItem('calloscareUser'); if(u) this.state.user = JSON.parse(u); } catch(e){} },
    saveUserToLocalStorage() { localStorage.setItem('calloscareUser', JSON.stringify(this.state.user)); },

    api: {
        async getAppConfig() { const r = await fetch(`${CallosCareApp.API_BASE_URL}/getAppConfig`); if (!r.ok) throw new Error('Network response was not ok'); return r.json(); },
        async saveClientData(d) { const r = await fetch(`${CallosCareApp.API_BASE_URL}/saveClient`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}); if (!r.ok) throw new Error('Failed to save client data'); return r.json(); },
        async saveDiagnosticData(d) { const r = await fetch(`${CallosCareApp.API_BASE_URL}/saveDiagnostic`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}); if (!r.ok) throw new Error('Failed to save diagnostic data'); return r.json(); },
    },

    async saveUser() {
        const fn=document.getElementById('user-first-name').value.trim(),ln=document.getElementById('user-last-name').value.trim(),e=document.getElementById('user-email')?.value.trim();
        if(!fn || !ln || !e || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)){ alert('Por favor, preencha todos os campos com um email válido.'); return; }
        const ud = {firstName: fn, lastName: ln, email: e};
        this.showSpinner('save-client-spinner');
        try { const res = await this.api.saveClientData(ud); this.state.user = { ...res.data[0] }; this.saveUserToLocalStorage(); this.goToStep('home');
        } catch (err) { alert(`Erro: ${err.message}`); } finally { this.hideSpinner('save-client-spinner'); }
    },
    
    startDiagnosis() { this.state.diagnosis = {locations:[],physicalChanges:[], suggestedProducts: [], userSelectedProducts: {}}; this.goToStep('step0_triage'); },
    goToStep(step) { this.state.currentStep = step; window.scrollTo(0,0); this.render(); },
    
    selectOption(key, value, nextFocusId = null) {
        this.state.diagnosis[key] = value;
        this.render();
        if (nextFocusId) { setTimeout(() => document.getElementById(nextFocusId)?.focus(), 100); } 
        else { setTimeout(() => document.querySelector('.step-next-btn')?.focus(), 100); }
    },

    toggleMultiOption(key,value){
        let a=this.state.diagnosis[key]||[];
        const i=a.indexOf(value);
        if(i>-1){a.splice(i,1);}else{a.push(value);}
        this.state.diagnosis[key] = a;
        this.render();
    },

    generateAndGoToResults() { this.goToStep('step5_results'); },

    async saveDiagnosis() {
        this.showSpinner('save-diag-spinner');
        const d = this.state.diagnosis;
        const resultsContent = this.generateTreatmentHtml(d, true);
        const payload = { client_id: this.state.user.id, callus_type_name: d.callusType, pain_level: d.painLevel, inflammation: d.inflammation, locations: d.locations, foot_type: d.footType, has_deformity: d.hasDeformity, is_diabetic: d.is_diabetic, treatment_protocol_html: resultsContent.fullHtml, suggested_products_snapshot: JSON.stringify(d.suggestedProducts) };
        try {
            await this.api.saveDiagnosticData(payload);
            d.isSaved = true;
            this.render();
        } catch (error) { alert(`Erro ao guardar: ${error.message}`);
        } finally { this.hideSpinner('save-diag-spinner'); }
    },

    showSpinner(id) { const el=document.getElementById(id); if(el) { el.classList.remove('hidden'); const btn=el.parentElement; if(btn) btn.setAttribute('disabled', 'true'); } },
    hideSpinner(id) { const el=document.getElementById(id); if(el) { el.classList.add('hidden'); const btn=el.parentElement; if(btn) btn.removeAttribute('disabled'); } },
    showImageZoom(event, imageUrl) { event.stopPropagation(); document.getElementById('zoomed-image').src = imageUrl; document.getElementById('image-zoom-modal').style.display = 'flex'; },
    showDefinition(event, contentKey) {
        event.stopPropagation();
        const item = this.state.appConfig.app_content.find(c => c.content_key === contentKey);
        if(item) {
            document.getElementById('definition-title').innerText = item.title;
            document.getElementById('definition-text').innerHTML = item.content_html;
            document.getElementById('definition-modal').style.display = 'block';
        }
    },
    closeModal() { document.getElementById('image-zoom-modal').style.display = 'none'; document.getElementById('definition-modal').style.display = 'none'; document.getElementById('product-modal').style.display = 'none'; },

    updateProgressBar() {
        const pbc=document.getElementById('progress-bar-container'),pb=document.getElementById('progress-bar');if(!pbc||!pb)return;
        const sm={'step0_triage':5,'step1_callusType':15,'step2_location':30,'step3_details':45,'step4_footType':60,'step5_results':75};
        const p=sm[this.state.currentStep]||0;
        if(p>0){pbc.classList.remove('hidden');pb.style.width=`${p}%`;}else{pbc.classList.add('hidden');}
    },
    
    generateTreatmentHtml(d, forSaving = false) {
        let fullHtml = ''; let suggestedProducts = new Set();
        const findContent = (key) => this.state.appConfig.app_content.find(c => c.content_key === key);
        if (d.painLevel >= 7 || d.inflammation) { const kit = findContent('emergency_kit_protocol'); if(kit) fullHtml += `<div class="p-4 border-l-4 border-red-500 bg-red-50 rounded-lg mb-4 prose max-w-none"><h3 class="text-red-700 font-bold text-center text-lg"><i class="fas fa-exclamation-triangle mr-2"></i>${kit.title}</h3><div class="text-left">${kit.content_html}</div></div>`; }
        const callusKey = d.callusType.toLowerCase().replace(/ \/ /g, '_').replace(/ /g, '_').replace(/[()]/g, '') + '_protocol';
        const mainProtocol = findContent(callusKey);
        if(mainProtocol) { fullHtml += `<div class="p-4 border-l-4 border-blue-500 bg-blue-50 rounded-lg mb-4 prose max-w-none"><h3 class="font-bold text-center text-lg">${mainProtocol.title.replace('Geral para ', '')}</h3><div class="text-left">${mainProtocol.content_html}</div></div>`; }
        if (d.hasDeformity) { const deformityInfo = findContent('deformity_info'); if(deformityInfo) { fullHtml += `<div class="p-4 border-l-4 border-yellow-500 bg-yellow-50 rounded-lg mb-4 prose max-w-none"><h3 class="font-bold text-center text-lg">Nota sobre Deformidades</h3><div class="text-left"><p>${deformityInfo.content_html}</p></div></div>`; }}
        this.state.appConfig.products.forEach(p => { if(d.footType === 'seco' && p.category === 'hidratacao') suggestedProducts.add(p.name); if(d.footType === 'humido' && p.category === 'controlo_humidade') suggestedProducts.add(p.name); if(d.inflammation && p.category === 'inflamacao_dor') suggestedProducts.add(p.name); });
        d.suggestedProducts = Array.from(suggestedProducts);
        return { fullHtml };
    },

    render() {
        this.updateProgressBar();
        const container = document.getElementById('calloscare-main-content');
        let content = '';
        const d = this.state.diagnosis;
        document.getElementById('app-title').innerHTML = `CallosCare <span class="text-sm font-light opacity-75">${this.VERSION}</span>`;
        
        const warningBanner = document.getElementById('diabetic-warning-banner');
        if (d && d.is_diabetic && this.state.currentStep.startsWith('step')) { if(warningBanner) warningBanner.classList.remove('hidden'); } else { if(warningBanner) warningBanner.classList.add('hidden'); }

        switch (this.state.currentStep) {
            case 'loading': content = `<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i></div>`; break;
            case 'error': content = `<div class="text-center p-8 text-red-500">Ocorreu um erro ao carregar. Tente recarregar a página.</div>`; break;
            case 'identification': content = `...`; break;
            case 'home': content = `...`; break;
            case 'step0_triage': content = `...`; break;
            case 'step1_callusType': content = `...`; break;
            case 'step2_location': content = `...`; break;
            case 'step3_details': content = `...`; break;
            case 'step4_footType': content = `...`; break;
            
            case 'step5_results':
                 const results = this.generateTreatmentHtml(d);
                 content = `
                    <h2 class="text-2xl font-semibold text-center mb-6">Plano de Tratamento Individualizado</h2>
                    <div id="treatment-results-content" class="space-y-4">${results.fullHtml}</div>
                    <div class="mt-6 p-4 bg-gray-100 rounded-lg">
                        <h4 class="font-bold text-lg text-left">Lista de Produtos Sugeridos:</h4>
                        <ul class="list-disc pl-5 mt-2 text-left">${(d.suggestedProducts&&d.suggestedProducts.length>0)?d.suggestedProducts.map(p=>`<li>${p}</li>`).join(''):'<li>Nenhum produto específico.</li>'}</ul>
                    </div>
                    <div class="flex justify-between items-center mt-8">${d.isSaved?`<span class="text-green-600 font-bold"><i class="fas fa-check-circle mr-2"></i>Diagnóstico Guardado</span><button onclick="CallosCareApp.goToStep('home')" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">Voltar ao Menu Principal</button>`:`<button onclick="CallosCareApp.goToStep('step4_footType')" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Voltar e Editar</button><button onclick="CallosCareApp.saveDiagnosis()" id="save-diag-spinner" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg">Guardar Diagnóstico <i class="fas fa-spinner fa-spin hidden ml-2"></i></button>`}</div>`;
                break;
            default: content = `<p class="text-center">Ocorreu um erro de navegação.</p>`; break;
        }
        container.innerHTML = `<div class="calloscare-step active">${content}</div>`;
        if (this.state.currentStep === 'identification') {
            // Placeholder for populateDateDropdowns if needed
        }
    }
};

document.addEventListener('DOMContentLoaded', () => CallosCareApp.init());
</script>
</body>
</html>
